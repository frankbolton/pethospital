<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8"/>
        <title>Pethospital Task</title>
        <link rel="stylesheet" type="text/css" href="/static/pethospital.css"/>
    </head>
  
    <body>
    <section id="test_pet_area">




            <script type="text/javascript" src="/static/pethospital.js"></script>
            <script type="text/javascript" src="/static/myStation.js"></script>
            <script type="text/javascript" src="/static/logEvents.js"></script>
            <script  type="text/javascript" src="/static/gameScore.js"></script>
        </section>
        <script type="text/javascript">

            //parts to replace using templating from Flask
            //var id = -1;
            //logEvents.setParticipantID({{id}});

            var station = [];
            var returnThis = "";
            var writeLogToServer = false;
            var logsWrittenToServer = false;

            //(start health / health delta / noise / name / pos_h / pos_w / handle to gameScrore)
            
            var count = 6;
            count = {{count}};

            if(count>1){
                station[0] = new myStation(100, 10, 1, "Tinky", 40, 50, gameScore);
                station[1] = new myStation(100, 4, 1, "Dinky", 40, 350, gameScore);
            }

            if(count > 3){
                station[2] = new myStation(100, 4, 1, "Loony", 40, 650, gameScore);
                station[3] = new myStation(100, 10, 1, "Shoony",340,50, gameScore);
            }

            if (count > 5){
                station[4] = new myStation(100, 4, 1, "Zoomy", 340, 350, gameScore);
                station[5] = new myStation(100, 10, 1, "Timmy", 340, 650, gameScore);
            }


            //var scores = new gameScore();

            gameScore.setDuration(10);
            gameScore.setScoreDeltas(1,1,1);

            var previousTime = 0;
            var previousMod = 999;
            var startTime = Date.now();
            var currentTime = 0;
            var currentMod = 0;


            function drawScreen() {
                if(writeLogToServer){
                    if(!logsWrittenToServer)
                    {
                        logEvents.pushLog();
                        logsWrittenToServer = true;
                    }                    
                }
                currentTime = Date.now();
//                if ((currentTime - previousTime ) > 1000)
                currentMod = currentTime % 1000;
                //console.log("the current mod is" + currentMod + " and the previous mod is " + previousMod);
                if (currentMod < previousMod)
                {
                    var allOK = true;
                    gameScore.tick();
                    var timeleft = gameScore.timeLeft();
                    for (i in station)  {
                        if (!timeleft){
                            station[i].timeIsUp();
                            writeLogToServer = true;   
                        }
                        else {
                            station[i].decrement();
                            allOK = allOK + station[i].OK();
                        }
                    }
                    if (allOK&&timeleft) {
                        gameScore.inc();
                        
                    }

                
                    previousTime = currentTime;
                }

                previousMod = currentMod;
            }

            function gameLoop() {
                window.setTimeout(gameLoop, 100);
                drawScreen();
                returnThis = encodeURIComponent(logEvents.printLog());
                document.getElementsByTagName('logs').value = returnThis;
            }

            gameLoop();
            
        </script>

        
    </body>
</html>